<%+header%>
<style>
.realsync-status-table { width:100%; border-collapse:collapse; margin-bottom:1em; }
.realsync-status-table th, .realsync-status-table td { border:1px solid #ddd; padding:8px; text-align:center; }
.realsync-status-table th { background:#f5f5f5; }
#realsync-log { width:100%; height:300px; background:#222; color:#eee; font-family:monospace; padding:10px; overflow:auto; border-radius:4px; }
</style>
<div class="cbi-section">
  <h2>realsync 服务状态</h2>
  <div id="service-status">加载中...</div>
  <button class="cbi-button cbi-button-apply" onclick="realsyncRestart()">强制重启</button>
</div>
<div class="cbi-section">
  <h2>任务运行状态</h2>
  <table class="realsync-status-table" id="task-table">
    <thead>
      <tr>
        <th>任务名</th>
        <th>启用</th>
        <th>运行状态</th>
      </tr>
    </thead>
    <tbody id="task-table-body">
      <tr><td colspan="3">加载中...</td></tr>
    </tbody>
  </table>
</div>
<div class="cbi-section">
  <h2>日志内容</h2>
  <button class="cbi-button" onclick="realsyncLogRefresh()">刷新日志</button>
  <button class="cbi-button" onclick="realsyncClearLog()">清空日志</button>
  <pre id="realsync-log">加载中...</pre>
</div>
<script type="text/javascript">
function realsyncStatus() {
  XHR.get('<%=luci.dispatcher.build_url("admin/services/realsync/get_status")%>', null, function(x, data) {
    document.getElementById('service-status').innerText = data && data.status ? data.status : '未知';
  });
}
function realsyncRestart() {
  if (!confirm('确定要重启 realsync 服务吗？')) return;
  XHR.get('<%=luci.dispatcher.build_url("admin/services/realsync/restart_service")%>', null, function(x, data) {
    alert(data && data.message ? data.message : '重启命令已发送');
    setTimeout(realsyncStatus, 1000);
    setTimeout(realsyncTaskStatus, 1500);
  });
}
function realsyncLogRefresh() {
  XHR.get('<%=luci.dispatcher.build_url("admin/services/realsync/get_log")%>', null, function(x, data) {
    document.getElementById('realsync-log').innerText = data && data.log ? data.log : '无日志';
  });
}
function realsyncClearLog() {
  if (!confirm('确定要清空日志吗？')) return;
  XHR.get('<%=luci.dispatcher.build_url("admin/services/realsync/clear_log")%>', null, function(x, data) {
    if (data && data.success) {
      alert(data.message || '日志已清空');
      realsyncLogRefresh();
    } else {
      alert(data && data.message ? data.message : '清空日志失败');
    }
  });
}
function realsyncTaskStatus() {
  XHR.get('<%=luci.dispatcher.build_url("admin/services/realsync/get_status")%>', null, function(x, data) {
    if (data && data.tasks) {
      var html = '';
      for (var i = 0; i < data.tasks.length; i++) {
        var task = data.tasks[i];
        html += '<tr><td>' + (task.name || '') + '</td><td>' + (task.enable ? '是' : '否') + '</td><td>' + (task.status || '未知') + '</td></tr>';
      }
      document.getElementById('task-table-body').innerHTML = html;
    } else {
      document.getElementById('task-table-body').innerHTML = '<tr><td colspan="3">暂未获取到任务状态</td></tr>';
    }
  });
}
window.onload = function() {
  realsyncStatus();
  realsyncLogRefresh();
  realsyncTaskStatus();
  setInterval(realsyncStatus, 5000);
  setInterval(realsyncTaskStatus, 5000);
};
</script>
<%+footer%> 